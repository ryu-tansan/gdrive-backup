========================================
Google Shared Drive Backup System
========================================

このシステムは、Google共有ドライブのデータをNASにバックアップします。

========================================
必要な環境
========================================

1. Windows 10/11
2. rcloneがインストール済み
   ダウンロード: https://rclone.org/downloads/
3. Google共有ドライブへのアクセス権限
4. NAS（Network Attached Storage）
   - 共有フォルダが設定済み
   - バックアップPC からアクセス可能

========================================
初回セットアップ手順
========================================

【ステップ1】rcloneでGoogle共有ドライブを設定

1. コマンドプロンプトまたはPowerShellを開く

2. 以下のコマンドを実行:
   rclone config

3. 以下の手順で設定:
   - n (新規作成)
   - 名前を入力 (例: shared_drive)
   - ストレージタイプで "drive" を選択
   - 以降すべてデフォルト (Enterキー)
   - "Use auto config?" → y (ブラウザでGoogle認証)
   - "Configure this as a Shared Drive?" → y
   - 共有ドライブを選択
   - 確認 → y → q

4. 接続テスト:
   rclone lsd shared_drive:
   (フォルダ一覧が表示されればOK)

【ステップ2】バックアップシステムの設定

1. setup.bat をダブルクリック

2. 画面の指示に従って設定:
   - rclone.exeのパス (通常はデフォルトでOK)
   - NASのパス (例: \\192.168.1.100\backup)
   - rcloneのリモート名 (ステップ1で設定した名前)
   - 保持する世代数 (推奨: 30)

3. 【重要】rclone設定の暗号化
   - rclone configが自動的に開きます
   - "s" を入力 (Set configuration password)
   - 強力なパスワードを設定 (20文字以上推奨)
   - パスワードを確認入力
   - "q" を入力して終了

4. パスワード保存方法を選択:
   オプション1: config.iniに保存 (自動実行可能・セキュリティやや低)
   オプション2: 毎回手動入力 (セキュリティ高・自動実行不可)

5. 設定内容を確認して保存

【ステップ3】NASのセキュリティ設定（必須）

バックアップ前に、必ずNASのセキュリティを強化してください：

1. NASの暗号化を有効化
   - NASの管理画面にログイン
   - 暗号化ボリューム/共有フォルダを作成
   - メーカー別の手順:
     * Synology: コントロールパネル → 共有フォルダ → 暗号化
     * QNAP: コントロールパネル → ストレージ → 暗号化
     * Buffalo: Web設定 → 共有フォルダ → 暗号化設定
   - 暗号化キーを安全な場所に保管

2. NASアクセスの制限
   - IPアドレスフィルタリングを有効化
   - バックアップPCのIPアドレスのみ許可
   - 不要なサービス（FTP等）を無効化

3. NASファームウェアの更新
   - 最新バージョンに更新
   - 自動更新を有効化

【ステップ4】テスト実行

1. backup.bat をダブルクリック

2. パスワードを設定した場合、入力を求められる

3. エラーなく完了することを確認

4. NAS上にバックアップフォルダが作成されていることを確認

========================================
定期実行の設定（推奨: 週1回）
========================================

【タスクスケジューラの設定】

注意: config.iniにパスワードを保存していない場合、
      タスクスケジューラでの自動実行はできません。

1. Windowsキー → "タスクスケジューラ" と入力

2. "基本タスクの作成" をクリック

3. 名前: Google Drive Backup

4. トリガー: 毎週

5. 曜日と時刻を選択 (例: 日曜日 午前2時)

6. 操作: プログラムの開始

7. プログラム/スクリプト: backup.bat のフルパスを入力
   例: C:\BackupSystem\backup.bat

8. 完了前に "プロパティを開く" にチェック

9. "条件" タブ:
   - "AC電源で使用..." のチェックを外す
   - "スリープを解除する" にチェック

10. OK で保存

========================================
バックアップされる内容
========================================

以下のファイルが1つのフォルダにバックアップされます:

【通常ファイル】
- PDF、Word、Excel、PowerPoint、画像、動画など
  → そのままコピーされます

【Googleドキュメント類】
- Googleドキュメント → docx形式でエクスポート
- Googleスプレッドシート → xlsx形式でエクスポート
- Googleスライド → pptx形式でエクスポート

すべてのファイルが同じフォルダに保存されるため、
復元時もシンプルです。

========================================
フォルダ構成
========================================

NAS上のフォルダ構成:

\\NASのパス\gdrive\
  ├─ backup_20251124_0200\    ← 最新のバックアップ
  │   ├─ file.pdf             (通常ファイル)
  │   ├─ image.png            (通常ファイル)
  │   ├─ document.docx        (Googleドキュメントからエクスポート)
  │   ├─ spreadsheet.xlsx     (スプレッドシートからエクスポート)
  │   └─ presentation.pptx    (スライドからエクスポート)
  ├─ backup_20251117_0200\    ← 1週間前
  ├─ backup_20251110_0200\    ← 2週間前
  │   ...
  └─ logs\                    (実行ログ)
      ├─ backup_20251124_0200.log
      └─ backup_20251117_0200.log

世代管理:
- デフォルト30世代（30週間分）が保持されます
- 31世代目以降は自動的に削除されます

========================================
セキュリティについて（重要）
========================================

このバックアップシステムのセキュリティは、以下の3層で構成されています：

【第1層：rclone設定の暗号化（必須）】

1. rclone configのパスワード保護
   - Google Driveアクセストークンを暗号化
   - setup.bat実行時に必ず設定
   - パスワードは20文字以上推奨
   - 絶対に忘れないこと

【第2層：NASの暗号化（最重要）】

2. NAS側の暗号化設定
   - バックアップデータを暗号化して保存
   - NAS盗難時のデータ漏洩を防止
   - 暗号化キーの安全な保管が必須

3. NASアクセス制御
   - IPアドレス制限
   - 強力なパスワード（20文字以上）
   - 2要素認証（利用可能な場合）
   - ファームウェアの定期更新

4. NASの物理的セキュリティ
   - 施錠できる場所に設置
   - UPS（無停電電源装置）の使用推奨
   - 重要データは月1回外付けHDDにコピーして別保管

【第3層：バックアップPCの保護】

5. Windows認証の強化
   - 強力なログインパスワード（20文字以上）
   - Windows Hello（指紋/顔認証）の有効化
   - 自動ログインの無効化

6. PCの物理的セキュリティ
   - 施錠できる場所に設置
   - ログイン中は席を離れない
   - スクリーンロックの自動有効化

7. 定期的なセキュリティ更新
   - Windows Updateの自動適用
   - rcloneの定期的なアップデート
   - ウイルス対策ソフトの導入

【ランサムウェア対策】

8. 多世代バックアップ
   - 30世代（30週間分）の保持
   - 感染に気づくまでの時間を確保
   - 感染前の世代から復元可能

9. バックアップ監視
   - 週1回、ログファイルを確認
   - 異常なファイル数の増減をチェック
   - バックアップ失敗時の即座の対応

========================================
セキュリティチェックリスト
========================================

セットアップ後、以下を必ず確認してください：

【必須項目】
□ rclone configがパスワードで保護されている
□ NASの暗号化が有効になっている
□ NAS暗号化キーを安全な場所に保管した
□ NASのアクセスがIPアドレスで制限されている
□ NASファームウェアが最新版である
□ バックアップPCのパスワードが強力（20文字以上）
□ バックアップが正常に実行されることを確認した
□ 世代管理が正しく機能することを確認した

【推奨項目】
□ Windows Hello（生体認証）を有効化した
□ NASにUPSを接続した
□ 月1回の外部メディアへのバックアップを計画した
□ バックアップ監視の担当者を決めた
□ NASとPCを施錠できる場所に設置した

========================================
NASメーカー別：暗号化設定ガイド
========================================

【Synology NAS】
1. DSMにログイン
2. コントロールパネル → 共有フォルダ
3. 作成 → 共有フォルダの暗号化にチェック
4. 暗号化キーを設定・保存
5. マウント時にキーを入力

【QNAP NAS】
1. QTS管理画面にログイン
2. ストレージ&スナップショット
3. ストレージ/スナップショット → ボリューム
4. 作成 → 暗号化を有効化
5. パスワードを設定・保存

【Buffalo NAS】
1. Web設定画面にログイン
2. 共有フォルダ → フォルダ設定
3. 暗号化機能を有効化
4. パスワードを設定

【Western Digital My Cloud】
1. ダッシュボードにログイン
2. 設定 → ユーティリティ
3. ドライブ暗号化を有効化
4. パスワードを設定

詳細は各メーカーのマニュアルを参照してください。

========================================
トラブルシューティング
========================================

【エラー: NAS path not accessible】
→ NASの電源、ネットワーク接続を確認
→ ネットワークドライブをマップしてみる:
  net use Z: \\NASのパス /user:ユーザー名 パスワード /persistent:yes

【エラー: Cannot connect to remote】
→ rclone config でリモート名を確認
→ rclone lsd リモート名: でテスト
→ Google Driveのアクセス権限を確認

【エラー: rclone.exe not found】
→ rcloneがインストールされているか確認
→ setup.bat を再実行して正しいパスを設定

【エラー: Incorrect rclone config password】
→ 入力したパスワードが間違っています
→ 正しいパスワードを確認して再入力
→ パスワードを忘れた場合は、rclone configから再設定が必要

【バックアップが実行されない】
→ タスクスケジューラで実行履歴を確認
→ PCが起動していない時間に設定していないか確認
→ backup.bat を手動で実行してエラーを確認
→ config.iniにパスワードが保存されているか確認

【NASの容量不足】
→ 世代数を減らす（setup.batで再設定）
→ 古い世代を手動で削除
→ NASのストレージ容量を増設

【ログファイルの確認方法】
→ NAS上の logs フォルダ内の .log ファイルをテキストエディタで開く
→ エラーメッセージを確認
→ "ERROR" や "FAILED" などのキーワードで検索

【一部のファイルがバックアップされない】
→ ログファイルで "skipped" や "error" を検索
→ ファイル名に特殊文字が含まれている可能性
→ アクセス権限の問題の可能性
→ ファイルサイズが大きすぎる可能性

【世代管理が機能しない】
→ バックアップフォルダの命名規則を確認
→ backup_YYYYMMDD_HHMM 形式になっているか
→ 手動で作成したフォルダが混在していないか

========================================
再設定が必要な場合
========================================

1. setup.bat を再度実行
2. 新しい設定で上書き保存される
3. rclone configのパスワードは変更されません
4. backup.bat で動作確認

rcloneのパスワードを変更したい場合:
1. rclone config を実行
2. "s" (Set configuration password) を選択
3. 新しいパスワードを設定
4. config.ini のパスワードも更新が必要（保存している場合）

========================================
ファイル一覧
========================================

setup.bat   - 初回設定用スクリプト
backup.bat  - バックアップ実行スクリプト
config.ini  - 設定ファイル (setup.bat実行後に自動生成)
README.txt  - このファイル
.gitignore  - Git管理除外設定

========================================
よくある質問
========================================

Q: Googleドキュメントを編集したら、バックアップも更新されますか?
A: はい。次回のバックアップ実行時に最新版がエクスポートされます。

Q: 削除したファイルはどうなりますか?
A: 次回バックアップ時には含まれません。
   ただし、過去の世代には残っているので復元可能です。

Q: バックアップ中にGoogle Driveを使用できますか?
A: はい。バックアップは読み取り専用なので影響ありません。

Q: NASの容量が足りなくなったら?
A: 世代数を減らす（setup.batで再設定）か、
   古い世代を手動で削除してください。

Q: 共有ドライブ全体ではなく、特定のフォルダだけバックアップできますか?
A: はい。backup.batのrcloneコマンドを修正することで可能です。
   例: "%REMOTE_NAME%:特定フォルダ名"
   (サポートが必要な場合はお問い合わせください)

Q: パスワードを忘れてしまいました
A: rclone configを再設定する必要があります。
   1. rclone config delete リモート名
   2. 再度 rclone config で設定
   3. setup.bat を実行して新しいリモート名を設定

Q: バックアップにどのくらい時間がかかりますか?
A: データ量とネットワーク速度によります。
   - 1GB: 数分〜10分程度
   - 10GB: 30分〜1時間程度
   - 100GB: 数時間〜半日程度

Q: ランサムウェアに感染したらどうすればいいですか?
A: 1. すぐにネットワークから切断
   2. バックアップPCの電源を切る
   3. 専門家に相談
   4. 感染前の世代からデータを復元

Q: NASが故障したらデータは失われますか?
A: NASのRAID設定によります。
   - RAID 1以上：ディスク1台故障でもデータ保護
   - RAID 0または単一ディスク：データ消失のリスクあり
   - 重要データは月1回外部メディアにもバックアップ推奨

========================================
サポート
========================================

問題が発生した場合は、以下の情報を用意してサポートに連絡:

1. エラーメッセージのスクリーンショット
2. ログファイル (NAS上の logs フォルダ内)
3. config.ini の内容 (パスワード情報は削除してください)
4. 実行環境の情報:
   - Windows のバージョン
   - rclone のバージョン (rclone version で確認)
   - NASの種類・モデル・ファームウェアバージョン
   - ネットワーク構成

========================================
更新履歴
========================================

v2.1 (2025-11-29)
- NASセキュリティ重視版にアップデート
- BitLocker推奨を削除（NAS暗号化を最優先に）
- NASメーカー別暗号化設定ガイド追加
- セキュリティチェックリスト更新

v2.0 (2025-11-29)
- セキュリティ強化版リリース
- rclone config暗号化を必須化
- Windowsエディション判定機能追加
- パスワード保存オプション追加
- エラーハンドリング改善

v1.1 (2025-11-24)
- 統合アプローチに変更（normalとexportedフォルダを統合）
- 重複バックアップの問題を解消

v1.0 (2025-11-24)
- 初版リリース

========================================